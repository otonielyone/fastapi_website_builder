{% extends "template.html" %}

{% block head %}
<link rel="stylesheet" href="/static/main.css">
<link rel="stylesheet" href="/static/rentals.css">
{% endblock %}

{% block header %}
{% endblock %}

{% block body %}
<div class="rentals-page-menu">
    <!-- Main Menu Bar -->
    <nav class="menu-bar">
        <div class="menu-column left-column">
            <a href="/" class="menu-link">HOME</a>
            <a href="/buying" class="menu-link">BUYING</a>
            <a href="/resources" class="menu-link">RESOURCES</a>
            <a href="/contact" class="menu-link">CONTACT</a>
        </div>
        <div class="menu-column right-column">
            <a href="#" class="language-icon">
                <img src="https://dd-cdn.multiscreensite.com/flags/flags_iso/32/us.png" alt="Language Icon" />
            </a>
        </div>
    </nav>

    <nav class="hamburger-menu" id="hamburger-menu">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
    </nav>

    <nav class="mobile-menu" id="mobile-menu">
        <a href="/" class="menu-item">HOME</a>
        <a href="/buying" class="menu-item">BUYING</a>
        <a href="/resources" class="menu-item">RESOURCES</a>
        <a href="/contact" class="menu-item">CONTACT</a>
    </nav>
</div>

<div class="image-header-container">
    <div class="video-background-wrapper">
        <video autoplay="autoplay" playsinline="playsinline" muted="muted" loop="loop" class="video-background-frame"
        src="/static/icons/rentals1.mp4"></video>

        <div class="overlay-content">
            <div class="text-content">
                <h1 class="main-heading">SEE BELOW FOR ROOMS AND APARTMENTS!</h1>
            </div>
        </div>
    </div>
</div>

<div class="rental-services" id="rental-services">
    <div class="rental-services-wrapper">
        <div class="light-red-text">
            <h2>LEASING QUALIFICATIONS:</h2>
            <p>Rooms may require an application fee ranging from $30 to $60...</p>
        </div>

        <div class="dark-red-text">
            <p>Note: If you do not meet these qualifications, the security deposit amount may be increased...</p>
        </div>

        <div class="navy-blue-text">
            <a href="/contact">
                <span class="text">Click here to request Availabilities!</span>
            </a>
        </div>

        <div class="black-text">
            <p>A signed agreement is necessary to physically enter properties...</p>
        </div>

        <div class="light-green-text">
            <a href="/static/icons/NVARK1282.pdf">
                Download Rental Representation Agreement
            </a>
        </div>
    </div>
</div>

<div id="loading" class="fullscreen-overlay" style="display: none;">
    <div class="loading-container">
        <div class="loading-text">Please wait 1 min while we gather the latest Availabilities..</div>
        <div class="progress-bar">
            <div id="progress-bar-inner" class="progress-bar-inner"></div>
        </div>
    </div>
</div>

<div class="automation">
    <title>Dynamic Button Grid</title>
    <section id="dynamic-buttons" class="button-grid">
    </section>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const loadingElement = document.getElementById('loading');
        const progressBarInner = document.getElementById('progress-bar-inner');
        const dynamicButtonsElement = document.getElementById('dynamic-buttons');
        let totalListings = 0;
        let processedListings = 0;
        let originalTotalListings = 0;

        loadingElement.style.display = 'block';

        const updateProgress = () => {
            if (originalTotalListings > 0) {
                const progress = Math.min((processedListings / originalTotalListings) * 100, 100);
                progressBarInner.style.width = `${progress}%`;
            } else {
                progressBarInner.style.width = '100%';
            }
        };

        const fetchListings = async () => {
            try {
                const totalResponse = await fetch('/api/total_count');
                const totalData = await totalResponse.json();
                originalTotalListings = totalData.total_count || 0;
                totalListings = originalTotalListings;

                if (totalListings === 0) {
                    progressBarInner.style.backgroundColor = 'red';
                    loadingElement.innerHTML = 'No data available.';
                    return;
                }

                const listingsResponse = await fetch('/api/listings');
                const listingsData = await listingsResponse.json();

                if (listingsData.listings && Array.isArray(listingsData.listings)) {
                    const processListing = () => {
                        if (processedListings < totalListings) {
                            const item = listingsData.listings[processedListings];
                            createButtonDiv(item);
                            processedListings++;
                            updateProgress();
                            requestAnimationFrame(processListing);
                        } else {
                            loadingElement.style.display = 'none';
                        }
                    };
                    processListing();
                } else {
                    console.error('Invalid data format:', listingsData);
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                loadingElement.style.display = 'none';
                progressBarInner.style.backgroundColor = 'red';
                loadingElement.innerHTML = 'Error loading data.';
            }
        };

        fetchListings();

        function createButtonDiv(data) {
            const { MLS, COST, ADDRESS, DESCRIPTION, STATUS, PHOTOS } = data;
            const photoList = Array.isArray(PHOTOS) && PHOTOS.length > 0 ? PHOTOS : ['static/icons/test.jpg'];

            const buttonDiv = document.createElement('div');
            buttonDiv.className = 'button-item';

            const button = document.createElement('button');
            button.style.padding = 0;
            button.style.border = 'none';
            button.style.background = 'none';

            const img = document.createElement('img');
            img.src = photoList[0];
            img.alt = 'Button Image';
            img.style.width = '150px';
            img.style.height = '150px';
            img.style.border = '3px solid #a8b8c6';
            img.style.borderRadius = '10px';
            img.style.boxShadow = '0 0 10px rgba(168, 184, 198, 0.7)';
            img.onerror = () => img.src = 'static/icons/test.jpg';

            const textDiv = document.createElement('div');
            textDiv.className = 'button-text';
            textDiv.innerHTML = `Cost: ${COST}<br>Address: ${ADDRESS}`;

            button.appendChild(img);
            button.appendChild(textDiv);

            button.onclick = (event) => {
                event.stopPropagation();
                showPopup(MLS, COST, ADDRESS, DESCRIPTION, STATUS, photoList);
            };

            buttonDiv.appendChild(button);
            dynamicButtonsElement.appendChild(buttonDiv);
        }

        function showPopup(MLS, COST, ADDRESS, DESCRIPTION, STATUS, PHOTOS) {
            const popup = document.createElement('div');
            popup.className = 'popup';

            const popupContent = document.createElement('div');
            popupContent.className = 'popup-content';

            const popupGallery = document.createElement('div');
            popupGallery.className = 'popup-gallery';

            const photoList = Array.isArray(PHOTOS) && PHOTOS.length > 0 ? PHOTOS : ['static/icons/test.jpg'];
            photoList.forEach(photo => {
                const img = document.createElement('img');
                img.src = photo;
                img.alt = 'Gallery Image';
                img.style.width = '150px';
                img.style.height = '150px';
                img.onerror = () => img.src = 'static/icons/test.jpg';
                popupGallery.appendChild(img);
            });

            const popupText = document.createElement('div');
            popupText.className = 'popup-text';
            popupText.innerHTML = `
                <h6>${COST} Monthly</h6>
                <p>${ADDRESS}</p>
                --------------------<br>
                <p>Description: ${DESCRIPTION}</p>
                --------------------<br>
                <p>${MLS}</p>
                <p>Status: ${STATUS}</p>
                <button class="contact-button" onclick="navigateToContact()">Click here to request more information</button><br><br>
            `;

            const popupClose = document.createElement('span');
            popupClose.className = 'popup-close';
            popupClose.innerHTML = '&times;';
            popupClose.onclick = () => closePopup(popup);

            popupContent.appendChild(popupGallery);
            popupContent.appendChild(popupText);
            popupContent.appendChild(popupClose);
            popup.appendChild(popupContent);
            document.body.appendChild(popup);

            document.addEventListener('click', (event) => {
                if (event.target === popup) {
                    closePopup(popup);
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closePopup(popup);
                }
            });

            function closePopup(popup) {
                popup.remove();
            }
        }

        window.navigateToContact = () => {
            window.location.href = '/contact';
        };
    });
</script>
{% endblock %}
